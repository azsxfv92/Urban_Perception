# Urban Perception 환경 구성 완전 가이드

## 목차
1. [개요](#개요)
2. [Docker 환경 구성 (권장)](#docker-환경-구성-권장)
3. [GStreamer 설치](#gstreamer-설치)
4. [ROS2 Humble 설치](#ros2-humble-설치)
5. [수동 설치](#수동-설치)
6. [문제 해결](#문제-해결)

---

## 개요

Urban Perception은 YOLOv5 모델을 TensorRT로 가속화하여 실시간 객체 검출을 수행하는 프로젝트입니다.

### 기본 환경
- **베이스 이미지**: dustynv/l4t-pytorch:r36.4.0 (yolo-benchmark와 동일)
- **CUDA**: 12.6
- **cuDNN**: 9.4
- **TensorRT**: 기본 포함
- **OpenCV**: 4.5.4
- **PyTorch**: 포함
- **GStreamer**: 1.0 (비디오 스트리밍용)

---

## Docker 환경 구성 (권장)

Docker를 사용하면 모든 종속성이 자동으로 설치되어 환경 구성이 간편합니다.

### 1. Docker 이미지 빌드

```bash
# Urban_perception 디렉토리에서 실행
cd /home/orin_nano_mh/DeepComPersonDetection/yolov5-master/Urban_perception
docker build -t urban-perception .
```

빌드 과정에서 다음 항목들이 자동으로 설치됩니다:
- 빌드 도구 (build-essential, cmake, git)
- **GStreamer 라이브러리 및 플러그인 (전체 패키지)**
- 프로젝트 빌드 (CMake + Make)

### 2. Docker 컨테이너 실행

#### Jetson 디바이스 (Orin Nano, Xavier 등)용

```bash
docker run -d --runtime nvidia --gpus all \
  --name urban-perception \
  -v $(pwd):/workspace/Urban_perception \
  -v /path/to/your/engine:/workspace/engine \
  -v /path/to/your/video:/workspace/video \
  urban-perception
```

**파라미터 설명:**
- `--runtime nvidia`: NVIDIA GPU 런타임 사용
- `--gpus all`: 모든 GPU 사용
- `--name urban-perception`: 컨테이너 이름 지정
- `-v $(pwd):/workspace/Urban_perception`: 현재 디렉토리를 컨테이너에 마운트
- `-v /path/to/your/engine:/workspace/engine`: TensorRT 엔진 파일 디렉토리 마운트
- `-v /path/to/your/video:/workspace/video`: 비디오 파일 디렉토리 마운트

### 3. 컨테이너 접속

```bash
docker exec -it urban-perception bash
```

컨테이너에 접속하면 자동으로 `/workspace/Urban_perception/build` 디렉토리로 이동합니다.

### 4. 객체 검출 실행

```bash
# 컨테이너 내부에서 실행 (이미 build 디렉토리에 위치)
./Urban_Perception /workspace/engine/yolov5s.engine /workspace/video/input.mp4

# 결과 확인
ls result_*.jpg
```

---

## GStreamer 설치

GStreamer는 비디오 스트리밍 처리를 위한 멀티미디어 프레임워크입니다.

### Docker 환경에서의 GStreamer

Docker 이미지를 빌드하면 다음 GStreamer 패키지들이 자동으로 설치됩니다:

#### 개발 라이브러리
- `libgstreamer1.0-dev`: GStreamer 핵심 개발 라이브러리
- `libgstreamer-plugins-base1.0-dev`: 기본 플러그인 개발 라이브러리
- `libgstreamer-plugins-good1.0-dev`: 안정화 플러그인 개발 라이브러리
- `libgstreamer-plugins-bad1.0-dev`: 확장 플러그인 개발 라이브러리

#### GStreamer 플러그인
- `gstreamer1.0-plugins-base`: 기본 플러그인 (필수)
- `gstreamer1.0-plugins-base-apps`: **appsrc/appsink 포함 (OpenCV 필수)**
- `gstreamer1.0-plugins-good`: 안정화된 플러그인
- `gstreamer1.0-plugins-bad`: 실험적 플러그인
- `gstreamer1.0-plugins-ugly`: 특허/라이선스 이슈가 있는 플러그인
- `gstreamer1.0-libav`: FFmpeg 기반 코덱 플러그인

#### GStreamer 도구 및 백엔드
- `gstreamer1.0-tools`: 명령줄 도구 (gst-launch, gst-inspect 등)
- `gstreamer1.0-x`: X11 비디오 출력
- `gstreamer1.0-alsa`: ALSA 오디오 백엔드
- `gstreamer1.0-gl`: OpenGL 지원
- `gstreamer1.0-gtk3`: GTK3 비디오 싱크
- `gstreamer1.0-qt5`: Qt5 비디오 싱크
- `gstreamer1.0-pulseaudio`: PulseAudio 오디오 백엔드

### GStreamer 설치 확인

컨테이너 내부에서 다음 명령으로 GStreamer가 제대로 설치되었는지 확인할 수 있습니다:

```bash
# GStreamer 버전 확인
gst-launch-1.0 --version

# 설치된 플러그인 목록 확인
gst-inspect-1.0

# 특정 플러그인 확인 (예: H.264 디코더)
gst-inspect-1.0 avdec_h264

# 간단한 비디오 재생 테스트
gst-launch-1.0 videotestsrc ! autovideosink
```

### 수동으로 GStreamer 설치 (Docker를 사용하지 않는 경우)

```bash
# 패키지 목록 업데이트
sudo apt-get update

# GStreamer 전체 패키지 설치
sudo apt-get install -y \
    libgstreamer1.0-dev \
    libgstreamer-plugins-base1.0-dev \
    libgstreamer-plugins-good1.0-dev \
    libgstreamer-plugins-bad1.0-dev \
    gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-base-apps \
    gstreamer1.0-plugins-good \
    gstreamer1.0-plugins-bad \
    gstreamer1.0-plugins-ugly \
    gstreamer1.0-libav \
    gstreamer1.0-tools \
    gstreamer1.0-x \
    gstreamer1.0-alsa \
    gstreamer1.0-gl \
    gstreamer1.0-gtk3 \
    gstreamer1.0-qt5 \
    gstreamer1.0-pulseaudio

# 환경 변수 설정 (Jetson용)
export GST_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/gstreamer-1.0:/usr/lib/gstreamer-1.0
export LD_LIBRARY_PATH=/usr/lib/aarch64-linux-gnu:${LD_LIBRARY_PATH}

# GStreamer 플러그인 캐시 생성
gst-inspect-1.0 &> /dev/null || true

# 캐시 정리
sudo rm -rf /var/lib/apt/lists/*
```

### CMakeLists.txt에서 GStreamer 사용

프로젝트에서 GStreamer를 사용하려면 CMakeLists.txt에 다음을 추가해야 합니다:

```cmake
# GStreamer 패키지 찾기
find_package(PkgConfig REQUIRED)
pkg_check_modules(GSTREAMER REQUIRED gstreamer-1.0)
pkg_check_modules(GSTREAMER_APP REQUIRED gstreamer-app-1.0)

# 헤더 파일 경로 추가
include_directories(${GSTREAMER_INCLUDE_DIRS})

# 라이브러리 링크
target_link_libraries(your_target ${GSTREAMER_LIBRARIES})
```

---

## ROS2 Humble 설치

ROS2 (Robot Operating System 2)는 로봇 소프트웨어 개발을 위한 미들웨어 프레임워크입니다.

### Docker 컨테이너 내에서 ROS2 Humble 설치

Docker 컨테이너 내부에서 다음 명령을 순서대로 실행합니다:

```bash
# 1. 패키지 인덱스 업데이트
apt update

# 2. 필요한 패키지 설치
apt install -y software-properties-common curl

# 3. universe 저장소 추가
add-apt-repository universe

# 4. ROS2 GPG 키 추가
curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg

# 5. ROS2 저장소 추가
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null

# 6. 패키지 목록 업데이트
apt update

# 7. ROS2 Humble Base 설치 (경량 버전)
apt install -y ros-humble-ros-base

# 또는 Desktop 버전 설치 (GUI 도구 포함, 용량 큼)
# apt install -y ros-humble-desktop

# 8. 개발 도구 설치
apt install -y ros-dev-tools python3-colcon-common-extensions

# 9. 환경 설정 (bashrc에 자동 로드 추가)
echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc

# 10. 현재 세션에 ROS2 환경 적용
source /opt/ros/humble/setup.bash
```

### ROS2 설치 확인

```bash
# ROS2 명령어 확인
ros2

# ROS2 시스템 상태 점검
ros2 doctor

# 토픽 목록 확인
ros2 topic list

# 설치된 ROS2 패키지 확인
apt list --installed | grep ros-humble
```

### ROS2 버전 정보

- **배포판**: Humble Hawksbill
- **지원 기간**: 2022년 5월 ~ 2027년 5월 (LTS)
- **Python 버전**: Python 3.10+
- **Ubuntu 버전**: Ubuntu 22.04 (Jammy Jellyfish)

### 주요 ROS2 패키지

프로젝트에 필요한 추가 ROS2 패키지를 설치할 수 있습니다:

```bash
# 이미지 처리 관련
apt install -y ros-humble-cv-bridge ros-humble-image-transport

# 센서 데이터 처리
apt install -y ros-humble-sensor-msgs ros-humble-geometry-msgs

# 비전 관련
apt install -y ros-humble-vision-msgs

# TF2 (좌표계 변환)
apt install -y ros-humble-tf2 ros-humble-tf2-ros
```

### ROS2 작업 공간 설정 (옵션)

ROS2 패키지 개발을 위한 작업 공간 생성:

```bash
# 작업 공간 디렉토리 생성
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws

# 작업 공간 빌드
colcon build

# 작업 공간 환경 설정
echo "source ~/ros2_ws/install/setup.bash" >> ~/.bashrc
source ~/ros2_ws/install/setup.bash
```

---

## 수동 설치

Docker를 사용하지 않고 직접 환경을 구성하는 경우입니다.

### 필수 요구사항

1. **CUDA Toolkit 12.6**
   ```bash
   # CUDA 설치 확인
   nvcc --version
   ```

2. **TensorRT**
   ```bash
   # TensorRT 설치 확인
   dpkg -l | grep TensorRT
   ```

3. **OpenCV 4.5.4+**
   ```bash
   # OpenCV 설치
   sudo apt-get install libopencv-dev python3-opencv

   # 버전 확인
   pkg-config --modversion opencv4
   ```

4. **CMake 3.10+**
   ```bash
   # CMake 설치
   sudo apt-get install cmake

   # 버전 확인
   cmake --version
   ```

5. **빌드 도구**
   ```bash
   sudo apt-get install build-essential git
   ```

### 빌드 과정

```bash
# 프로젝트 디렉토리로 이동
cd /home/orin_nano_mh/DeepComPersonDetection/yolov5-master/Urban_perception

# 빌드 디렉토리 생성
mkdir -p build
cd build

# CMake 구성
cmake ..

# 빌드
make

# 실행 파일 확인
ls -l Urban_Perception
```

### 실행

```bash
# 빌드 디렉토리에서 실행
./Urban_Perception <engine_file> <video_file>

# 예시
./Urban_Perception ../yolov5s.engine ../input.mp4
```

---

## 문제 해결

### 1. GStreamer 관련 오류

**증상 1**: `no element "appsrc"` 오류

**해결방법**:
```bash
# appsrc/appsink 플러그인 설치 확인
gst-inspect-1.0 appsrc
gst-inspect-1.0 appsink

# 없다면 base-apps 패키지 설치
sudo apt-get update
sudo apt-get install gstreamer1.0-plugins-base-apps

# 플러그인 캐시 재생성
rm -rf ~/.cache/gstreamer-1.0/
gst-inspect-1.0 &> /dev/null

# 환경 변수 설정
export GST_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/gstreamer-1.0:/usr/lib/gstreamer-1.0
```

**증상 2**: `GStreamer not found` 또는 라이브러리 링크 오류

**해결방법**:
```bash
# GStreamer 설치 확인
dpkg -l | grep gstreamer

# 재설치
sudo apt-get update
sudo apt-get install --reinstall libgstreamer1.0-dev

# pkg-config 경로 확인
pkg-config --cflags --libs gstreamer-1.0
```

### 2. CUDA 오류

**증상**: `CUDA driver version is insufficient`

**해결방법**:
```bash
# CUDA 드라이버 확인
nvidia-smi

# 필요시 드라이버 업데이트
sudo apt-get update
sudo apt-get install nvidia-driver-xxx
```

### 3. TensorRT 엔진 로드 실패

**증상**: `Failed to load engine file`

**해결방법**:
- 엔진 파일 경로 확인
- 엔진 파일이 현재 TensorRT 버전과 호환되는지 확인
- 필요시 엔진 재생성

```bash
# TensorRT 버전 확인
dpkg -l | grep TensorRT
```

### 4. OpenCV 관련 오류

**증상**: `opencv2/opencv.hpp: No such file or directory`

**해결방법**:
```bash
# OpenCV 개발 패키지 설치
sudo apt-get install libopencv-dev

# 헤더 파일 위치 확인
find /usr -name opencv.hpp
```

### 5. Docker 빌드 실패

**증상**: Docker 이미지 빌드 중 오류 발생

**해결방법**:
```bash
# Docker 캐시 없이 재빌드
docker build --no-cache -t urban-perception .

# 빌드 로그 자세히 보기
docker build -t urban-perception . 2>&1 | tee build.log
```

### 6. 컨테이너에서 GPU 사용 불가

**증상**: `CUDA error: no CUDA-capable device is detected`

**해결방법**:
```bash
# nvidia-docker 런타임 확인
docker run --rm --runtime=nvidia nvidia/cuda:11.0-base nvidia-smi

# 컨테이너 재시작
docker restart urban-perception
```

---

## 추가 정보

### 검출 가능한 객체 클래스
- Person (사람)
- Bicycle (자전거)
- Car (자동차)
- Motorcycle (오토바이)
- Bus (버스)
- Truck (트럭)
- Traffic light (신호등)
- Stop sign (정지 신호)

### 출력 파일 형식
- `result_0.jpg`: 0프레임 (시작)
- `result_31.jpg`: 약 1초 후
- `result_62.jpg`: 약 2초 후
- ... (약 1초마다 저장)

### 성능 최적화
- FP16 엔진 사용 시 속도 향상
- 배치 크기 조정
- 입력 해상도 조정

---

**문의 및 이슈 리포트**: GitHub Issues에 등록해주세요.
